////////////////////////////////////////////////////////////////
//  파일 : DOMContentLoaded.js                                //
//  작성자 : mobbing                                          //
//  주석 : onload 이벤트 때 동작할 것들.                       //
///////////////////////////////////////////////////////////////


const dcheck = (d1, d2) => {
	if ( parseInt(d1[0], 10) < parseInt(d2[0], 10) ) {
		return false;
	} else if ( parseInt(d1[0], 10) === parseInt(d2[0], 10) ) {
		if ( parseInt(d1[1], 10) < parseInt(d2[1], 10) ) {
			return false;
		} else if ( parseInt(d1[1], 10) === parseInt(d2[1], 10) ) {
			if ( parseInt(d1[2], 10) < parseInt(d2[2], 10) ) {
				return false;
			}
		}
	}

	return true;
};

const notiCheck = async () => {
	const res = await axios.get('https://sopia-bot.firebaseio.com/app/notice.json');
	const notices = res.data;
    const d = new Date(), now = new Date();
    const config = orgRequire(getPath('config.json'));
	d.setDate(d.getDate() - 7);

	let lastNotiIdx = parseInt(config['noti-idx'], 10);
	if ( Number.isNaN(lastNotiIdx) ) {
		lastNotiIdx = -1;
	}

	if ( !notices ) {
		return;
	}

	if ( notices.length >= lastNotiIdx ) {
		for ( let i = lastNotiIdx+1;i < notices.length;i++ ) {
			const noti = notices[i];
			const pd = d.yyyymmdd('-').split('-');
			const nd = noti.date.split('-');
			if ( dcheck(nd, pd) ) {
				await newAlertModal(noti.title, noti.content);
			}
			config['noti-idx'] = i;
        }
        AllSettingSave(config, null, true);
	}

	if ( window.DEBUG_MODE ) {
		//await newAlertModal('TEST', 'TEST Content');
		//await newAlertModal('asdfasdf', '안녕하세요. 스푼 DJ여러분. 개발자 윤군입니다.<br>오늘은 매우 안타까운 소식을 전해드리게 되어 대단히 죄송합니다.<br>제목에 나와있는대로 소피아는 잠시 안드로메다 저 건너로 사라질 것입니다.<br><br>어떤 말을 해야될지 모르겠으니 요지만 말하겠습니다.<br><br>공식 배포 후 446일이라는 시간이 지난 소피아가, 앞으로 무기한 서비스가 정지됩니다.<br>저는 회사도 아니고 기계도 아닙니다. 아주 작은 일에도 큰 상처를 받는 소심한 인간으로서, 스푼은 더 이상 행복이 아닌 불행만 존재하는 공간이 되었기 때문에 떨어지려고 합니다.<br>오픈 소스로 전환된 소피아를 서비스 중지되어도 동작할 수 있도록 수정은 가능하겠으나, 저는 <b>수정하지 않아주셨으면 합니다.</b><br>저는 스푼에서 소피아란 존재를 서서히 잊어가길 원합니다.<br><br>굿즈도 만들고 싶었고, 더 하고 싶었던 것도 많았지만 그것보단 지금은 도망치고 싶은 생각밖에 없네요.<br><br>5월 8일 토요일. 서버를 정지하겠습니다. 지금까지 여러분들의 목소리, 정말로 아름다웠습니다. 언제나 예쁜 그 상태로 남아있길 바랍니다.<br>언젠가 제게 남은 상처들이 익숙해졌을 때 돌아오겠습니다.<br><br>~ 𝐹𝑜𝓇 𝒴𝑜𝓊𝓇 𝒱𝑜𝒾𝒸𝑒 ~');
	}
};


const loadInit = async (config = {}) => {
	loadCustomPage();
	await notiCheck();
};

document.addEventListener('DOMContentLoaded', async (evt) => {
	const config = orgRequire(getPath('/config.json'));
	await loadInit(config);

	/*               S: IMPORT               */

	/**
	* dashboard를 controls에 import 시킨다.
	* display: block으로 둔다.
	*/
	document.querySelector('#controls').appendImport('#home', (parent, target) => {
		target.setAttribute('data-target', 'home');
	});

	/**
	* ez-cmd를 controls에 import 시킨다.
	* display: block으로 둔다.
	*/
	document.querySelector('#controls').appendImport('#ez-cmd', (parent, target) => {
		target.setAttribute('data-target', 'ez-cmd');
	});

	/**
	* for dj를 controls에 import 시킨다.
	* display: none으로 둔다.
	*/
	/*
	document.querySelector('#controls').appendImport('#for-dj', (parent, target) => {
		console.log('for dj!!!');
		target.setAttribute('data-target', 'for-dj');
	});
	*/

	/**
	* code를 controls에 import 시킨다.
	* 그와 동시에 monaco editor를 세팅한다.
	* display는 none으로 둔다.
	*/
	document.querySelector('#controls').appendImport('#code', (parent, target) => {
		target.style.display = "none";
		target.setAttribute('data-target', 'code');
		require(['vs/editor/editor.main'], () => {
			require.config({
				paths: {
					'vs': getPath('vs')
				}
			});
			window.editor = monaco.editor.create(target.querySelector('#codeDiv'), {
				value: "",
				language: 'javascript',
				theme: sopia.config.sopia['dark-editor'] ? 'vs-dark' : 'vs',
				automaticLayout: true
			});
			window.editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_S, () => {
				if ( window.code.viewPath ) {
					const codeVal = window.editor.getValue();
					const ext = path.extname(window.code.viewPath);
					const rtn = jsSyntax(codeVal, ext === '.json');
					if ( !rtn.result ) {
						const modal = document.querySelector('#code-modal');
						if ( modal ) {
							document.querySelector('#err-title').innerText = rtn.msg;
							document.querySelector('#message').innerHTML =
								`${rtn.line} 번째 줄에서 에러가 발생했습니다!<br>` +
								`${rtn.syntax}`;
							UIkit.modal(modal).show();
						}
						return;
					}

					fs.writeFile(window.code.viewPath, codeVal, {encoding: 'utf8'}, (err) => {
						if ( err ) {
							throw err;
						}
						window.code.viewCode = window.editor.getValue();
						if ( noti ) {
							noti.success('파일 저장에 성공했습니다.', path.basename(window.code.viewPath));
						}
					});
				}
			});
			window.editor.addCommand(monaco.KeyCode.F5, () => {
				if ( sopia.isLoading === true ) {
					loadScript(() => {
						noti.success('리로딩', '코드가 적용되었습니다.');
					});
				} else {
					noti.success('리로딩', '방송에 입장하면 저장된 코드가 적용됩니다.');
				}
			});
			refreshTree(path.join(window.code.sopiaPath, "main.js"));
		});
	});

	/**
	 * spoorchat을 controls에 import 시킨다.
	 * display는 nonde으로 둔다.
	 */
	document.querySelector('#controls').appendImport('#spoorchat', async (parent, target) => {
		target.style.display = "none";
		target.setAttribute('data-target', 'spoorchat');



		// 설정값 로딩

		document.querySelector('#enableSpoorChat').checked = sopia.config.spoor.enable;
		document.querySelector('#minimumSpoon').value = sopia.config.spoor.minspoon;
		document.querySelector('#effectVolume').value = sopia.config.spoor.effectvolume;
		document.querySelector('#ttsVolume').value = sopia.config.spoor.ttsvolume;
		document.querySelector('#toutSpoor').value = sopia.config.spoor.toutspoor;
		if ( sopia.config.spoor.enableInfoSend === undefined) {
			sopia.config.spoor.enableInfoSend = true;
		}
		document.querySelector('#enableInfoSend').checked = enableInfoSend;


		if ( sopia.config.spoor.typecast && sopia.config.spoor.typecast.use ) {
			const email = sopia.config.spoor.typecast.email;
			const password = sopia.config.spoor.typecast.password;
			const user = await TC.initLogin(email, password);
	
			if ( user ) {
				noti.success('로그인 성공', user.email);
			}
			window.TCVoices = await TC.getVoiceList();
		}
	
		const tcidx = sopia.config.spoor.tcidx;
		const type = sopia.config.spoor.type;

		const vtype = document.querySelector('#voiceType');
		vtype.dataset.type = type;
		if ( typeof tcidx === 'number' ) {
			vtype.dataset.tcidx = tcidx;
		}
		if ( type === 'typecast' ) {
			vtype.innerText = 'T: ' + TCVoices[sopia.config.spoor.tcidx].name.ko
		} else {
			if ( speech.voices[type] ) {
				vtype.innerText = speech.voices[type].label;
			} else {
				vtype.innerText = type;
			}
		}

		// button event setting
		document.getElementsByName('toggle-body').forEach((element) => {
			element.addEventListener('click', (evt) => {
				let aButton = evt.target;
				if ( aButton.tagName.toLowerCase() !== "a" ) {
					aButton = aButton.parentElement;
				}
				if ( aButton.tagName.toLowerCase() !== "a" ) {
					aButton = aButton.parentElement;
				}
				const targetBody = document.querySelector(aButton.dataset.target);
				const visible = aButton.dataset.view;

				if ( targetBody ) {
					if ( visible === "true" ) {
						// hide body
						aButton.setAttribute('uk-icon', 'icon: triangle-left; ratio: 1.5');
						aButton.dataset.view = "false";
						targetBody.className = "uk-card-body uk-animation-slide-bottom-small";
						targetBody.style.display = "none";
					} else {
						// show body
						aButton.setAttribute('uk-icon', 'icon: triangle-down; ratio: 1.5');
						aButton.dataset.view = "true";
						targetBody.className = "uk-card-body uk-animation-slide-top-small";
						targetBody.style.display = "block";
					}
				}
			});
		});

		const sigKeys = Object.keys(sopia.config.spoor.signature);
		sigKeys.forEach(k => {
			appendSignature(k, sopia.config.spoor.signature[k]);
		});

		loaded['spoor'] = true;
	});

	/**
	* setting을 controls에 import 시킨다.
	* display는 none으로 둔다.
	*/
	document.querySelector('#controls').appendImport('#setting', (parent, target) => {
		target.style.display = "none";
		target.setAttribute('data-target', 'setting');



		// 설정 값 로딩

		//SOPIA 설정
		document.querySelector('#autoManagerStart').checked = sopia.config.sopia.autostart;
		document.querySelector('#dark-editor').checked = sopia.config.sopia['dark-editor'];
		document.querySelector('#keep-login').checked = sopia.config.sopia['keep-login'];
        document.querySelector('#default-url').value = sopia.config.sopia['default-url'];
        if ( sopia.config['version-fix'] ) {
            document.querySelector('#version-select').innerText = sopia.config.version;
        }

		const webview = window.webview || document.querySelector('#webview');
		webview.src = sopia.config.sopia['default-url'];

		//자동 로그인 설정
		document.querySelector('#autoLoginEnable').checked = sopia.config.autologin.enable;
		document.querySelector('#autoLoginId').value = sopia.config.autologin.id;
		document.querySelector('#autoLoginPw').value = sopia.config.autologin.passwd;
		document.querySelector(`#altItems>li[data-type="${sopia.config.autologin.type}"]>a`).click();
	});

	/**
	* bundle을 controls에 import 시킨다.
	* display는 none으로 둔다.
	*/
	document.querySelector('#controls').appendImport('#bundle', async (parent, target) => {
		target.style.display = "none";
		target.setAttribute('data-target', 'bundle');

		const apeendCardItem = (name, bundle, isUsing) => {
			if ( !bundle ) return;

			const parentItem = document.createElement('div');
			parentItem.className = "uk-margin-small-bottom";

			const item = document.createElement('div');
			item.className = "uk-card uk-card-default uk-card-hover spoor-card";

			const body = document.createElement('div');
			body.className = "uk-card-body";
			body.style = "min-height: 150px";

			const permission = document.createElement('div');

			if ( bundle.permission === "all" ) {
				permission.className = "uk-card-badge uk-label uk-label-spoon";
				permission.innerText = "청취자";
			} else if ( bundle.permission === "manager" ) {
				permission.className = "uk-card-badge uk-label uk-label-danger";
				permission.innerText = "매니저";
			} else if ( bundle.permission === "admin" ) {
				permission.className = "uk-card-badge uk-label uk-label-black";
				permission.innerText = "관리자";
			}


			const title = document.createElement('h3');
			title.className = "uk-card-title";
			if ( bundle.help ) {
				title.innerHTML = `<a href="${bundle.help}" target="_blank" style="color: #66b3ff;">${bundle.cmd}</a>`;
			} else {
				title.innerText = bundle.cmd;
			}

			const desc = document.createElement('p');
			desc.innerText = bundle.desc;

			const footer = document.createElement('div');
			footer.className = "uk-card-footer uk-text-right";
			footer.style = "padding-right: 27px";

			const maker = document.createElement('span');
			maker.className = "uk-margin-small-right";
			maker.innerText = bundle.maker;

			const useButton = document.createElement('button');

			const uninstall = (evt) => {
				if ( bundle.href ) {
					if ( fs.existsSync(getPath(sopia.config.bundle[name])) ) {
						rimraf.sync(getPath(sopia.config.bundle[name]));
					}
					useButton.className = "uk-button uk-button-small uk-button-primary";
					useButton.innerText = "사용";
					useButton.removeEventListener('click', uninstall);
					useButton.addEventListener('click', install);

					delete sopia.config.bundle[name];
					AllSettingSave(sopia.config, () => {
						noti.success(name, "번들 삭제.");
						if ( sopia.isLoading ) {
							loadScript();
						}
					});
				}
			};

			const install = async (evt) => {
				if ( bundle.reqVer ) {
					if ( verCompaire(sopia.config.version, bundle.reqVer) < 0 ) {
						let msg = '버전 정보가 맞지 않습니다.\n';
						msg += `프로그램을 업데이트 해주시기 바랍니다.\n\n`;
						msg += `현재 버전: ${sopia.config.version}\n`;
						msg += `요구 버전: ${bundle.reqVer}`;
						alertModal('알림', msg);
						return;
					}
				}

				if ( bundle.href ) {
					const res = await axios.get(bundle.href);
					const data = res.data;

					const bdir = `sopia/${bundle.type || 'bundles'}/${name}`;
					const bundlePath = getPath(bdir);
					const bundleDir = path.dirname(bundlePath);
					if ( !fs.existsSync(bundleDir) ) {
						fs.mkdirSync(bundleDir);
					}

					sopia.debug(bundlePath, data);
					if ( !fs.existsSync(bundlePath) ) {
						sopia.debug("no exist bundle");
						fs.mkdirSync(bundlePath);
					}

					const target = path.join(bundlePath, 'index.js');
					fs.writeFileSync(target, data, {encoding: 'utf8'});

					useButton.innerText = "삭제";
					useButton.className = "uk-button uk-button-small uk-button-danger uk-button";
					useButton.removeEventListener('click', install);
					useButton.addEventListener('click', uninstall);

					if ( typeof sopia.config.bundle !== "object" ) {
						sopia.config.bundle = {};
					}

					sopia.config.bundle[name] = bdir;
					AllSettingSave(sopia.config, () => {
						noti.success(name, "번들 추가.");
						if ( sopia.isLoading ) {
							loadScript();
						}
					});

					// download dependency
					if ( bundle.dep ) {
						const deps = bundle.dep[process.arch];
						if ( Array.isArray(deps) ) {
							for ( const d of deps ) {
								const depPath = path.join(bundlePath, d.name);

								if ( !fs.existsSync(path.dirname(depPath)) ) {
									fs.mkdirSync(path.dirname(depPath));
								}

								const file = fs.createWriteStream(depPath);
								https.get(d.href, (res) => {
									res.pipe(file);
								});
							}
						}
					}
				} else {
					noti.error('다운로드 정보가 없습니다.');
				}
			};
			if ( isUsing ) {
				useButton.className = "uk-button uk-button-small uk-button-danger uk-button";
				useButton.innerText = "삭제";
				useButton.addEventListener('click', uninstall);
			} else {
				useButton.className = "uk-button uk-button-small uk-button-primary";
				useButton.innerText = "사용";
				useButton.addEventListener('click', install);
			}

			body.appendChild(permission);
			body.appendChild(title);
			body.appendChild(desc);

			footer.appendChild(maker);
			footer.appendChild(useButton);

			item.appendChild(body);
			item.appendChild(footer);
			parentItem.appendChild(item);

			document.querySelector('#bundleList').appendChild(parentItem);
		};

		// 번들 리스트 로딩

		const bundleURL = sopia.config['api-url'] + '/bundle.json';
		let res = await axios.get(bundleURL);
		let data = res.data;
		let keys = Object.keys(data);
		keys.forEach(k => {
			const bundle = data[k];
			const isUsing = sopia.config.bundle[k] ? true : false;
			apeendCardItem(k, bundle, isUsing);
		});

		// 번들 리스트 로딩

		if ( window.DEBUG_MODE ) {
			const bundleDebugURL = sopia.config['api-url'] + '/debug-server/bundle.json';
			res = await axios.get(bundleDebugURL);
			data = res.data;
			if ( data ) {
				keys = Object.keys(data);
				keys.forEach(k => {
					const bundle = data[k];
					const isUsing = sopia.config.bundle[k] ? true : false;
					apeendCardItem(k, bundle, isUsing);
				});
			}
		}

		{
			// 다른 작업 카드 추가
			const parentItem = document.createElement('div');
			parentItem.className = "uk-margin-small-bottom";

			const item = document.createElement('div');
			item.className = "uk-card uk-card-default uk-card-hover spoor-card";
			item.style.display = "flex";

			const body = document.createElement('div');
			body.className = "uk-card-body";
			body.style = "height: 211px; align-items: center; display: flex; width: 100%;";

			const title = document.createElement('button');
			title.className = "uk-card-title uk-button uk-button-text uk-text-lead";
			title.style = "margin: auto;";
			title.innerText = "다른 작업";
			title.addEventListener('click', (evt) => {
				UIkit.modal(document.querySelector('#other-job')).show();
			});

			body.appendChild(title);
			item.appendChild(body);
			parentItem.appendChild(item);
			document.querySelector('#bundleList').appendChild(parentItem);
		}
	});
	/*               E: IMPORT               */

	/*               S: MENU CLICK               */
	document.querySelectorAll('div.uk-navbar-left>ul.uk-navbar-nav>li>a').forEach(element => {
		element.addEventListener('click', (evt) => {
			//e.target이 a 태그가 아닐 경우, 그 부모를 탐색하여 a 태그를 찾는다.
			let checkAtag = true;
			let e = {target: evt.target};
			while ( e.target.tagName.toLowerCase() !== "a" ) {
				if ( e.target.parentElement ) {
					if ( e.target.parentElement.tagName.toLowerCase() === "body" ) {
						checkAtag = false;
						break;
					}
					e.target = e.target.parentNode;
				}
			}

			if ( checkAtag ) {
				routingPage(e.target);
			}
		});
	});

	/**
	* dashboard를 controls에 import 시킨다.
	* display: block으로 둔다.
	*/
	document.querySelector('#controls').appendImport('#other', (parent, target) => {
		target.setAttribute('data-target', 'other');
	});

	/*               E: MENU CLICK               */

	document.querySelector('#home-tab').click();

	if ( sopia.config ) {
		if ( sopia.config.version ) {
			document.title = `SOPIA - ${sopia.config.version}`;
			if ( window.DEBUG_MODE ) {
				document.title = 'Chrome';
			}
		}
	}

	INJECTORS.forEach((injector) => injector.complete());
	sopia.wlog('SUCCESS', 'DOMContentLoad complete');
});
